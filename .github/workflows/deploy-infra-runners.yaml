name: Terraform Deploy

on:
  pull_request:
    types: [closed]
    branches:
      - dev
      - stage
      - main

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: self-hosted

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # - name: Update package lists (with password)
      #   env:
      #     USER_PASSWORD: ${{ secrets.RUNNER_PASSWORD }}
      #   run: |
      #     echo "$USER_PASSWORD" | sudo -S apt-get update
      #     sudo apt-get update && sudo apt-get install -y unzip && sudo unzip file.zip

      - name: Check if Terraform is installed
        id: check_terraform
        run: |
          if command -v terraform >/dev/null 2>&1; then
            echo "Terraform already installed"
            echo "installed=true" >> "$GITHUB_OUTPUT"
          else
            echo "Terraform not installed"
            echo "installed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install Terraform if needed
        if: steps.check_terraform.outputs.installed == 'false'
        uses: hashicorp/setup-terraform@v3

      - name: Check Terraform version
        run: terraform version

        # env:
        # TF_VAR_my_secret: ${{ secrets.AWS_ACCOUNT_ID }}

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Debug Base Branch
        run: |

          echo "GITHUB_BASE_REF: $GITHUB_BASE_REF"
          echo "Pull Request Event: $EVENT_DATA"
        env:
          EVENT_DATA: ${{ toJson(github.event) }}

      - name: Set Environment Based on Base Branch
        run: |
          if [[ -z "$GITHUB_BASE_REF" ]]; then
            echo "GITHUB_BASE_REF is empty. Make sure this workflow is triggered by a pull request."
            exit 1
          fi

          echo "Pull Request Base Branch: $GITHUB_BASE_REF"
          if [[ "$GITHUB_BASE_REF" == "dev" ]]; then
            echo "This PR targets the 'dev' branch."
            echo "ENV=development" >> $GITHUB_ENV
          elif [[ "$GITHUB_BASE_REF" == "state" ]]; then
            echo "This PR targets the 'stage' branch."
            echo "ENV=stage" >> $GITHUB_ENV
          elif [[ "$GITHUB_BASE_REF" == "main" ]]; then
            echo "This PR targets the 'main' branch."
            echo "ENV=production" >> $GITHUB_ENV
          else
            echo "This PR targets an unsupported branch."
            exit 1
          fi

      - name: Run Environment-Specific Steps
        run: |
          if [[ "${ENV}" == "dev" ]]; then
            echo "Running development tasks..."
          elif [[ "${ENV}" == "staging" ]]; then
            echo "Running stage tasks..."
          elif [[ "${ENV}" == "prod" ]]; then
            echo "Running production tasks..."
          fi

        # - name: Setup Terraform Infrastructure (Development Only)
        #   if: env.ENV == 'development'
        #   run: |
        #     echo "Setting up infrastructure for development - network state..."

      - name: Setup Terraform Infrastructure (Development Only)
        if: env.ENV == 'dev'
        run: |
          echo "Setting up infrastructure for development - network state..."
          cd /home/github/actions-runner/_work/walkthrough/walkthrough
          ./run dev network init -var-file=../dev.tfvars
          ./run dev network plan -var-file=../dev.tfvars -out=../tfplan

        # ./run dev network apply -auto-approve ../tfplan
        # echo "Setting up infrastructure for development - compute state..."
        # cd /home/ubuntu/actions-runner/marketup/marketup-ops/marketup-ops/terraform
        # ./run dev compute init -var-file=../dev.tfvars
        # ./run dev compute plan -var-file=../dev.tfvars -out=tfplan
        # ./run dev compute apply -var-file=../dev.tfvars -auto-approve tfplan

        # - name: Destroy Terraform Infrastructure (Development Only)
        #   if: env.ENV == 'dev'
        #   run: |
        #     echo "Destroying infrastructure for development - network state..."
        #     cd /home/ubuntu/actions-runner/marketup/marketup-ops/marketup-ops/terraform
        #     ./run dev network init -var-file=../dev.tfvars
        #     ./run dev network destroy -var-file=../dev.tfvars -auto-approve
        env:
          ENV: dev
